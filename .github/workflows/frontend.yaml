name: Build & Deploy Frontend

on:
  push:
    branches: ["master"]
    paths:
      - "authos-frontend/**"
      - ".github/workflows/frontend.yaml"

env:
  IMAGE_VERSION_PATTERN: "alpha-${{ github.sha }}"
  DOCKERHUB_NAMESPACE: "stevetosak"

jobs:
  frontend-build-push:
    runs-on: ubuntu-22.04
    outputs:
      IMAGE_LATEST: ${{ steps.frontend_image_tags.outputs.IMAGE_LATEST }}
      IMAGE_VERSION: ${{ steps.frontend_image_tags.outputs.IMAGE_VERSION }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('authos-frontend/**/package-lock.json') }}

      - name: Build React frontend
        working-directory: ./authos-frontend
        run: |
          npm ci
          npm run build

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - name: Set Frontend image tags
        id: frontend_image_tags
        run: |
          IMAGE_LATEST="${{ env.DOCKERHUB_NAMESPACE }}/authos-ui:latest"
          IMAGE_VERSION="${{ env.DOCKERHUB_NAMESPACE }}/authos-ui:${{ env.IMAGE_VERSION_PATTERN }}"
          echo "IMAGE_LATEST=$IMAGE_LATEST" >> $GITHUB_OUTPUT
          echo "IMAGE_VERSION=$IMAGE_VERSION" >> $GITHUB_OUTPUT

      - name: Build & push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./authos-frontend
          push: true
          tags: |
            ${{steps.frontend_image_tags.outputs.IMAGE_LATEST}}
            ${{steps.frontend_image_tags.outputs.IMAGE_VERSION}}

  deploy-frontend:
    needs: frontend-build-push
    runs-on: ubuntu-22.04
    steps:
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2.1.0

      - name: Checkout infra repo
        uses: actions/checkout@v4
        with:
          repository: 'stevetosak/${{vars.INFRA_REPO_NAME}}'
          token: '${{secrets.INFRA_REPO_TOKEN}}'
          path: '${{vars.INFRA_REPO_NAME}}'

      - name: Update Overlay
        run: |
          cd ${{vars.INFRA_REPO_NAME}}/${{vars.INFRA_REPO_FRONTEND_OVERLAY_DIR}}
          kustomize edit set image ${{needs.frontend-build-push.outputs.IMAGE_VERSION}}

      - name: Commit and Push Changes
        run: |
          cd ${{vars.INFRA_REPO_NAME}}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --cached --quiet || git commit -m "Update Frontend image"
          git push origin HEAD
